<!DOCTYPE HTML>
<html lang="en">

<meta charset="utf-8" />

<HEAD>
<style>
.seqtext {
  //display: block;
  font-family: Georgia, serif;
  white-space: pre;
  margin: 1em 0;
}

html,
body {
  //margin-top: 50px;
  padding: 0;
  //box-sizing: border-box;
  background: #fff;
  color: #778899;
  float: center;
}

h1 {
  //display: inline-block;
  width: 20%;
  font-family: "Verdana", sans-serif;
  font-size: 3em;
  font-weight: 100;
  text-transform: none;
  letter-spacing: 3px;
  text-align: center;
  color: #364e65;
  padding: 0;
  margin-left: auto;
  margin-right: auto;
  text-shadow: 1px 1px 2px;
}

.tab {
  width: 80%;
  //font-family: 'Trebuchet MS', sans-serif;
  font-family: 'Times New Roman', serif;
  margin: auto;  
}


.bar-button {
  background-color: #4682B4;
  /* Navy blue */
  color: white;
  padding: 15px 30px;
  text-align: center;
  //float:left;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  font-weight: bold;
  //text-transform: uppercase;
  font-variant-caps: petite-caps;
  border: 1px solid #4682B4;
  //border-style: outset none solid double;
}
.bar-button, .bar-button0 {
  float:left;
  }
  
.button1:hover {
  box-shadow: 0 4px 5px 0 rgba(0, 0, 0, 0.24), 0 17px 50px 0 rgba(0, 0, 0, 0.19);
  background-image: radial-gradient(#6495ED, #4682B4, #4682B4);
}

.bar .bar-button {
  //width: 30%;
  float: left;
  //display: inline-block;
}

.bar-button0 {
  background-color: #4682B4;
  font-stretch: ultra-expanded;
  font-family: Garamond, serif;
  font-size: 25px;
  /* Navy blue */
  color: white;
  padding: 8.5px 20px;
  text-align: center;
  //float:left;
  text-decoration: none;;
  font-size: 25px;
  font-weight: bolder;
  font-weight: bold;
  border: 1px solid #4682B4;
}

.bar .bar-button0 {
  //width: 10%;
  float: left;
}
.bar .bar-button:active {
  background-color: #4682B4;
  box-shadow: 0 5px #666;
  //transform: translateY(1px);
}

   
</style>


    <TITLE>miRBind</TITLE>
    <link rel='icon' href='RBPlogo.png'>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.0.0/dist/tf.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"> </script>
    <!script src="http://wzrd.in/bundle/biojs-io-fasta@latest"></script>
  </HEAD>

  <BODY>


    
    <div class="bar buttons">
	  <button style="width:10%"class="bar-button0 button0">miRBind</button>
	  <button style="width:30%" class="bar-button button1" onclick="openTab('about')">About</button>
      <button style="width:30%" class="bar-button button1" onclick="openTab('single')">Single Pair</button>
      <button style="width:30%" class="bar-button button1" onclick="openTab('multiple')">Multiple Pairs</button>
    </div>
    <br /><br /><br /><br />

     <div id="about" class="bar tab">
      <FORM method="post" enctype="multipart/form-data" ><br />
        <h4><strong>About miRBind</strong></h4>
		<p>The <strong>miRBind JS</strong> web interface predicts the potential of miRNA:target binding. To use our machine learning method, first choose the size of the input by clicking either on <i><strong>Single pair</strong></i> or on <i><strong>Multiple pairs</strong></i>). For multiple input pairs, you are prompted to select the format of the input (<i><strong>Line separated</strong></i> or <i><strong>Multi-FASTA</strong></i>).</p>
	<DIV class="prob1" , id="prob1"><p>For more info about miRBind, click <A href="" target="_blank" rel="noopener noreferrer">here</A>.</p></DIV><br/>
      </FORM>
    </div>
	
	
	<div id="single" class="bar tab" style="display:none">
      <FORM method="post" enctype="multipart/form-data" ><br />
        <h4><strong>Single miRNA-target pair</strong></h4>

        <BR />
        <p>Insert miRNA sequence (20 nt) here</p>

        <DIV><input type="text" name="text11" id="text11" size="50" style="width:70%;height:50px;" pattern="[AUCGaucg]{20}" placeholder="Paste miRNA sequence" required></DIV>
        <BR />
        <p>Insert target mRNA sequence (50 nt) here</p>
        <DIV><input type="text" name="text12" id="text12" size="50" style="width:70%;height:50px;" pattern="[AUCGaucg]{50}" placeholder="Paste mRNA sequence" required></DIV><BR />

        <button type="button" value="Load example" name="example1" onclick="loadExample1()">Load example</button><input type="reset" value="Reset" name="reset"><button type="button" value="Submit" name="submit" onclick="makePrediction1()">Submit</button>
			
		<br/><br/>
		<DIV class="prob" , id="prob2"></DIV><br/>
      </FORM>
    </div>


    <div id="multiple" class="bar tab" style="display:none">
      <FORM method="post" enctype="multipart/form-data"><br />
        <h4><strong>Multiple miRNA-target pairs</strong></h4>
      <LABEL class="radio-inline">
        <INPUT type="radio" name="optradio" id="fasta" required>Line separated
        </LABEL>
      <LABEL class="radio-inline">
        <INPUT type="radio" name="optradio" id="multiline">Multi-FASTA
        </LABEL>
        <BR /><BR />
        <p>Insert miRNA (20 nt) sequences here</p>

        <DIV><textarea name="text21" id="text21" style="width:70%;height:100px;" pattern="[A-Za-z]{20}" placeholder="Paste mRNA sequences" required></textarea></DIV>
        <BR />
        <p>Insert target mRNA sequences (50 nt) here</p>
        <DIV><textarea name="text22" id="text22" style="width:70%;height:100px;" pattern="[A-Za-z]{50}" placeholder="Paste mRNA sequences" required></textarea></DIV><BR />

        <input type="reset" value="Reset" name="reset"><button type="button" value="Submit" name="submit" onclick="makePrediction2()">Submit</button>
		<br/><br/>
		<DIV class="prob" , id="prob3"></DIV><br/>
      </FORM>
    </div><BR /><br /><br /><br /><br />

<script>
function validateSequence(sequence, minSize, maxSize) {
  if (sequence.length > maxSize) {
    return 'The sequence is too long. The sequence needs to be equal to '.concat(maxSize, '.');
  } else if (sequence.length < minSize) {
    return 'The sequence is too short. The sequence needs to be equal to '.concat(minSize, '.');
  } else if ('' != sequence.replace(/A/g, '').replace(/T/g, '').replace(/C/g, '').replace(/G/g, '').replace(/N/g, '')) {
    return 'The sequence must consist only of "A", "C", "T", "G".';
  } else {
    return '';
  }
}


function formatOutput(sequence, results, error = 0, seq_name = '', output_type = 'text') {
  if (output_type == 'text') {
    return formatText(sequence, results, error, seq_name)
  } else {
    return formatTable(sequence, results, error, seq_name)
  }
}


function openTab(tabName) {
  var i;
  var x = document.getElementsByClassName("tab");
  for (i = 0; i < x.length; i++) {
    x[i].style.display = "none";
  }
  document.getElementById(tabName).style.display = "block";
}


function simpleSeq(x) {
  return {
    name: '',
    seq: x
  };
}

async function makePrediction3() {
  document.getElementById('prob3').innerHTML = "loaded";
  // load model
  var model = undefined;
  modelUrl = "https://raw.githubusercontent.com/Ilektra-Giassa/miRBind01/gh-pages/assets/model.json";
  model = await tf.loadLayersModel(modelUrl);
  console.log("model loaded...");
  document.write("loaded");
  //document.getElementById('prob2').innerHTML = "loaded";
  var txt21 = document.getElementById('text21').value;
  var txt22 = document.getElementById('text22').value;
  document.write(txt21);
  var seqArray21 = [];
  var seqArray22 = [];

  if (document.getElementById('fasta').checked) {
    var fasta = require("biojs-io-fasta");
    seqArray21 = fasta.parse(txt21);
    document.write(seqArray21[0]);
    seqArray22 = fasta.parse(txt22);
  }
  if (document.getElementById('multiline').checked) {
    seqArray21 = txt21.split(/\r?\n/).map(simpleSeq);
    seqArray22 = txt22.split(/\r?\n/).map(simpleSeq);
  }

  for (var i = 0; i < seqArray21.length; i++) {

    var s21 = seqArray21[i].seq.toUpperCase();

    // check the sequence format
    const validation21 = validateSequence(s21, 20, 20)
    if (validation21 != '') {
      console.log("wrong input...");
      prob.innerHTML += formatOutput(s21, validation21, 1, seqArray21[i].name, output_type);
      continue;
    }
    var s221 = s21;


    // output
    ////prob.innerHTML += formatOutput(s221, results21, 0, seqArray[i].name, output_type);
  }


  document.write("\nchecked mir");

  for (var i = 0; i < seqArray22.length; i++) {

    var s22 = seqArray22[i].seq.toUpperCase();

    // check the sequence format
    const validation22 = validateSequence(s22, 50, 50)
    if (validation21 != '') {
      console.log("wrong input...");
      prob.innerHTML += formatOutput(s21, validation22, 1, seqArray22[i].name, output_type);
      continue;
    }
    var s222 = s22;
  }

  // output
  ////prob.innerHTML += formatOutput(s222, results22, 0, seqArray[i].name, output_type); 



  document.write("\nchecked mrna");

  a = new Array(50);
  for (var i = 0; i < a.length; i++) {
    a[i] = new Array(20);
  }

  for (var i = 0; i < a.length; i++) {
    for (var j = 0; j < 20; j++) {
      a[i][j] = 1;
    }
  }
  const xs = tf.tensor(a);
  //document.write(xs);

  //const result = model.predict(a).asScalar().dataSync();
  ////const result = model.predict(xs).asScalar().dataSync();
  //document.write(result);

}

async function makePrediction2() {

  // get HTML elements
  var prob = document.getElementById('prob3');
  ////prob.innerHTML = '';
  var txt21 = document.getElementById('text21').value;
  var txt22 = document.getElementById('text22').value;

  console.log("model loading...");

  // clear the model variable
  var model2 = undefined;
  // load model
  modelUrl2 = "https://raw.githubusercontent.com/Ilektra-Giassa/miRBind01/gh-pages/assets/model.json";
  model = await tf.loadLayersModel(modelUrl2);
  console.log("model loaded...");


  // parse input text into the array of sequences
  var seqArray21 = [];
  var seqArray22 = [];

  if (document.getElementById('fasta').checked) {
    var fasta = require("biojs-io-fasta");
    seqArray21 = fasta.parse(txt21);
    seqArray22 = fasta.parse(txt22);
  }
  if (document.getElementById('multiline').checked) {
    seqArray21 = txt21.split(/\r?\n/).map(simpleSeq);
    seqArray22 = txt22.split(/\r?\n/).map(simpleSeq);
  }




  // process the array of sequences
  for (var i = 0; i < seqArray21.length; i++) {

    var s21 = seqArray21[i].seq.toUpperCase();

    // check the sequence format
    const validation21 = validateSequence(s21, 20, 20)
    if (validation != '') {
      console.log("wrong input miR...");
      prob.innerHTML += formatOutput(s, validation, 1, seqArray[i].name, output_type);
      continue;
    }
    var s2 = s;

    const Ntries = 100; // number of tries 
    var results = [];
    for (j = 0; j < Ntries; j++) {

      // from string to one-hot array

      // inference
      ////results.push(parseFloat(model.predict(a).asScalar().dataSync()));
    }

    // output
    ////prob.innerHTML += formatOutput(s21, results, 0, seqArray[i].name, output_type);
  }

  for (var i = 0; i < seqArray22.length; i++) {

    var s22 = seqArray22[i].seq.toUpperCase();

    // check the sequence format
    const validation22 = validateSequence(s22, 50, 50)
    if (validation != '') {
      console.log("wrong input mRNA...");
      prob.innerHTML += formatOutput(s22, validation, 1, seqArray[i].name, output_type);
      continue;
    }
    var s2 = s;

    const Ntries = 100; // number of tries 
    var results = [];
    for (j = 0; j < Ntries; j++) {

      // from string to one-hot array

      // inference
      ////results.push(parseFloat(model.predict(a).asScalar().dataSync()));
    }

    // output
    ////prob.innerHTML += formatOutput(s, results, 0, seqArray[i].name, output_type);
  }

}


async function makePrediction1() {
  var txt11 = document.getElementById('text11').value;
  var txt12 = document.getElementById('text12').value;
  var prob = document.getElementById('prob2');
  prob.innerHTML = '';
  const seq11 = txt11.replace(/\r?\n|\r/g, '').replace(/\s/g, '');
  const seq12 = txt12.replace(/\r?\n|\r/g, '').replace(/\s/g, '');
  seqArray11 = seq11;
  seqArray12 = seq12;

  var s11 = seq11.toUpperCase();
  var s12 = seq12.toUpperCase();
  const validation11 = validateSequence(s11, 20, 20)
  if (validation11 != '') {
    console.log("wrong mir");
    prob.innerHTML += "<br/>Check the format of the miRNA. "
    prob.innerHTML += validateSequence(s11, 20, 20);
  }

  const validation12 = validateSequence(s12, 50, 50)
  if (validation12 != '') {
    console.log("wrong mrna");

    prob.innerHTML += "<br/>Check the format of the mRNA. "
    prob.innerHTML += validateSequence(s12, 50, 50);
  }

  // load model
  if ((validation11 == '') & (validation12 == '')) {
    var model = undefined;
    //modelUrl = "https://raw.githubusercontent.com/Ilektra-Giassa/miRBind01/gh-pages/assetsPenguinnConvert/model.json";
    //modelUrl = "https://raw.githubusercontent.com/Ilektra-Giassa/miRBind01/gh-pages/assets/model.json";
    //model = await tf.loadLayersModel("https://raw.githubusercontent.com/ML-Bioinfo-CEITEC/penguinn/gh-pages/assets/model.json");
	modelUrl = "https://raw.githubusercontent.com/ML-Bioinfo-CEITEC/miRBind/gh-pages/assets/model.json";
	prob.innerHTML += "Loading the model...";
    model = await tf.loadLayersModel(modelUrl);
	prob.innerHTML += "Predicting..";
    console.log("model loaded...");	
    char = s11.charAt(1) + s12.charAt(1);
    console.log(char);
    input = "";
    for (var i = 0; i < 1000; i++) {
      input[i] = new Array(20);
    }
    binding = ["AT", "TA", "CG", "GC"];
    if (binding.includes(char)) {
      console.log("included");
    }
    for (var i = 0; i < 50; i++) {
      for (var j = 0; j < 20; j++) {
        char = s11.charAt(j) + s12.charAt(i);
        if (binding.includes(char)) {
          input += '1';
        } else {
          input += '0';
        }
      }
    }

    const y1 = tf.tensor1d(input.split(''), 'int32');
    y2 = y1.reshape([1, 50, 20, 1]);
    var result = model.predict(y2).asScalar().dataSync();
    console.log("predicting..");
	prob.innerHTML = "";
    prob.innerHTML += "<br/><strong>Input</strong><br/>miRNA  " + s11 + "<br/>mRNA  " + s12;
    prob.innerHTML += "<br/><br/><br/><strong>Prediction</strong><br/>The score of the putative interaction is: " + " <strong>" + result + "</strong>";
  }
}


function oneHot(s50) {
  // one-hot encoding
  const t = s50.replace(/A/g, '7').replace(/T/g, '1').replace(/C/g, '2').replace(/G/g, '3').replace(/N/g, '1')
  const y = tf.oneHot(tf.tensor1d(t.split(''), 'int32'), 20);
  return y.reshape([1, 50, 20, 1]);
}

function loadExample1() {
  miRex1 = "TCCGAGCCTGGGTCTCCCTC";
  mRNAex1 = "TTCAGGAGAAGCTGAGAGAGACCCAGGAGTATAACCGAATTCAGAAGGAG";
  document.getElementsByName("text11")[0].value = miRex1;
  document.getElementsByName("text12")[0].value = mRNAex1;
  var prob = document.getElementById('prob2');
  prob.innerHTML = "";
  prob.innerHTML += "<br/><strong>Input</strong><br/>miRNA  " + miRex1 + "<br/>mRNA  " + mRNAex1;
  prob.innerHTML += "<br/><br/><br/><strong>Prediction</strong><br/>The score of the putative interaction is: " + " <strong>0.9977567791938782</strong>";
}

	</script>
		
  </BODY>

</HTML>
